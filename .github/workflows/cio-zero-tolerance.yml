# CIO ZERO TOLERANCE - NO 200-ERROR COMMITS
name: "CIO Zero Tolerance - Block All Errors"

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  mobile-validation:
    name: "Mobile: Lint + Type + Test"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./DeliveryAppMobile
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: DeliveryAppMobile/package-lock.json
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run ESLint
      run: npm run lint
      
    - name: Run TypeScript check
      run: npm run typecheck
      
    - name: Run tests
      run: npm test
      
    - name: Check for hardcoded IPs
      run: |
        if grep -r "192\.168\." src/ --include="*.ts" --include="*.tsx"; then
          echo "‚ùå HARDCODED IP DETECTED - PR BLOCKED"
          exit 1
        fi
        
  backend-validation:
    name: "Backend: Test + Lint + Type"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./DeliveryAppBackend
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install ruff mypy
        
    - name: Run Django tests
      run: python manage.py test
      
    - name: Run Ruff linting
      run: ruff check .
      
    - name: Run MyPy type checking
      run: mypy . --exclude migrations
      
  failure-notification:
    name: "CIO Notification"
    runs-on: ubuntu-latest
    needs: [mobile-validation, backend-validation]
    if: failure()
    
    steps:
    - name: Block PR with CIO message
      run: |
        echo "üö® CIO ZERO TOLERANCE POLICY VIOLATION"
        echo "‚ùå This PR contains lint/type/test errors"
        echo "üîß Fix ALL errors before attempting merge"
        echo "‚ö†Ô∏è  Next violation: lunch debt + public apology"
        exit 1